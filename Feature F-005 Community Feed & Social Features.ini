# Feature F-005: Community Feed & Social Features

**Priority:** P1 (Should Have)  
**Status:** MVP  
**Dependencies:** F-001 (Authentication), F-002 (Family Tree), F-003 (Timeline)  
**Estimated Effort:** 2-3 weeks

---

## Overview
Activity feed showing recent updates from trees user belongs to, with social interactions (reactions, comments, sharing). Real-time updates via Supabase Realtime.

---

## Requirements

### Activity Feed
- **F-005.1:** Activity feed showing recent updates from trees user belongs to
- **F-005.2:** Feed items include:
  - New timeline posts
  - New members added
  - Member profile updates
  - Milestone celebrations (birthdays, anniversaries)
- **F-005.3:** Chronological and algorithmic feed options
- **F-005.4:** Like/react to feed items
- **F-005.5:** Comment on feed items
- **F-005.6:** Share feed items to other trees
- **F-005.7:** Notification system:
  - In-app notifications
  - Email notifications (configurable)
  - Push notifications (Phase 2)

---

## Technical Implementation

### Tech Stack
- **Real-time:** Supabase Realtime (PostgreSQL subscriptions)
- **Database:** PostgreSQL
- **Email:** Supabase Edge Functions + Resend or SendGrid
- **Push Notifications:** (Phase 2: Firebase Cloud Messaging)

### Database Schema
```sql
-- Activity Feed
CREATE TABLE activity_feed (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tree_id UUID REFERENCES trees(id) ON DELETE CASCADE,
  actor_id UUID REFERENCES auth.users(id), -- Who performed the action
  action_type TEXT NOT NULL, -- new_post, new_member, birthday, anniversary, etc.
  entity_type TEXT NOT NULL, -- post, member, tree
  entity_id UUID NOT NULL, -- ID of the post/member/tree
  metadata JSONB, -- Additional context (e.g., post title, member name)
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Notifications
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  activity_id UUID REFERENCES activity_feed(id) ON DELETE CASCADE,
  message TEXT NOT NULL,
  read_status BOOLEAN DEFAULT false,
  link TEXT, -- Deep link to relevant page
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Notification Preferences
CREATE TABLE notification_preferences (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email_new_posts BOOLEAN DEFAULT true,
  email_new_members BOOLEAN DEFAULT true,
  email_birthdays BOOLEAN DEFAULT true,
  email_comments BOOLEAN DEFAULT true,
  email_mentions BOOLEAN DEFAULT true,
  email_digest_frequency TEXT DEFAULT 'daily', -- immediate, daily, weekly, never
  in_app_notifications BOOLEAN DEFAULT true,
  push_notifications BOOLEAN DEFAULT false,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Feed Reactions (separate from post reactions for flexibility)
CREATE TABLE feed_reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  activity_id UUID REFERENCES activity_feed(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  reaction_type TEXT NOT NULL, -- like, love, celebrate, laugh
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(activity_id, user_id, reaction_type)
);

-- Indexes
CREATE INDEX idx_activity_feed_tree_id ON activity_feed(tree_id);
CREATE INDEX idx_activity_feed_created_at ON activity_feed(created_at DESC);
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_read_status ON notifications(user_id, read_status);

-- RLS Policies
ALTER TABLE activity_feed ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users see feed from their trees"
  ON activity_feed FOR SELECT
  USING (
    tree_id IN (
      SELECT tree_id FROM tree_roles WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users see own notifications"
  ON notifications FOR SELECT
  USING (user_id = auth.uid());

CREATE POLICY "Users can mark own notifications as read"
  ON notifications FOR UPDATE
  USING (user_id = auth.uid());
```

### Trigger: Create Activity on Post
```sql
-- Automatically create feed activity when new post is created
CREATE OR REPLACE FUNCTION create_post_activity()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO activity_feed (tree_id, actor_id, action_type, entity_type, entity_id, metadata)
  VALUES (
    NEW.tree_id,
    NEW.creator_id,
    'new_post',
    'post',
    NEW.id,
    jsonb_build_object(
      'title', NEW.title,
      'post_date', NEW.post_date
    )
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER post_activity_trigger
AFTER INSERT ON timeline_posts
FOR EACH ROW EXECUTE FUNCTION create_post_activity();
```

### Trigger: Create Notifications
```sql
-- Create notifications for tree members when activity occurs
CREATE OR REPLACE FUNCTION create_activity_notifications()
RETURNS TRIGGER AS $$
BEGIN
  -- Insert notification for all tree members except the actor
  INSERT INTO notifications (user_id, activity_id, message, link)
  SELECT 
    tr.user_id,
    NEW.id,
    generate_notification_message(NEW.action_type, NEW.metadata),
    generate_notification_link(NEW.entity_type, NEW.entity_id)
  FROM tree_roles tr
  WHERE tr.tree_id = NEW.tree_id
    AND tr.user_id != NEW.actor_id
    AND tr.user_id IN (
      SELECT user_id FROM notification_preferences 
      WHERE in_app_notifications = true
    );
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER notification_trigger
AFTER INSERT ON activity_feed
FOR EACH ROW EXECUTE FUNCTION create_activity_notifications();
```

### API Endpoints
```typescript
// Feed
GET    /api/feed                      // Get activity feed (paginated)
GET    /api/feed/algorithmic          // Get algorithmic feed
POST   /api/feed/:activityId/react    // React to activity
DELETE /api/feed/:activityId/react    // Remove reaction

// Notifications
GET    /api/notifications             // Get notifications (paginated)
PUT    /api/notifications/:id/read    // Mark as read
PUT    /api/notifications/read-all    // Mark all as read
GET    /api/notifications/unread-count // Get unread count

// Preferences
GET    /api/notifications/preferences
PUT    /api/notifications/preferences
```

### Real-time Subscriptions
```typescript
// Subscribe to new activity in user's trees
const subscription = supabase
  .channel('activity_feed')
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'activity_feed',
      filter: `tree_id=in.(${userTreeIds.join(',')})`
    },
    (payload) => {
      // Add new activity to feed
      addActivityToFeed(payload.new);
    }
  )
  .subscribe();

// Subscribe to notifications
const notificationSub = supabase
  .channel('notifications')
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'notifications',
      filter: `user_id=eq.${userId}`
    },
    (payload) => {
      // Show notification badge
      incrementUnreadCount();
      showToast(payload.new.message);
    }
  )
  .subscribe();
```

---

## User Flows

### View Feed Flow
1. User navigates to Feed page
2. Feed loads with latest 20 activities
3. Activities display with:
   - Actor profile photo and name
   - Action description
   - Timestamp (e.g., "2 hours ago")
   - Related content preview (post thumbnail, member photo)
   - Reaction and comment counts
4. User scrolls, more activities load
5. New activity appears at top with animation (real-time)

### React to Activity Flow
1. User sees interesting post in feed
2. Hovers over reaction button
3. Reaction picker appears (â¤ï¸ ðŸ‘ ðŸŽ‰ ðŸ˜‚)
4. User clicks â¤ï¸
5. Reaction count increments immediately
6. Actor receives notification

### Comment Flow
1. User clicks comment icon on activity
2. Inline comment box expands
3. User types comment
4. Presses Enter or clicks "Post"
5. Comment appears immediately
6. Actor and other commenters receive notifications

### Notification Flow
1. New activity occurs in user's tree
2. Notification appears in dropdown (bell icon)
3. Badge shows unread count
4. User clicks notification
5. Navigates to relevant page (post, member profile)
6. Notification marked as read

---

## UI/UX Requirements

### Feed Layout
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Feed  |  Algorithmic                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ðŸ‘¤ Sarah added a new memory       â”‚ â”‚
â”‚  â”‚    "Christmas 2024"               â”‚ â”‚
â”‚  â”‚    [Photo Preview]                â”‚ â”‚
â”‚  â”‚    â¤ï¸ 5  ðŸ’¬ 2  ðŸ”— Share  2h ago    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ðŸ‘¤ John added Michael to tree     â”‚ â”‚
â”‚  â”‚    Family Tree                    â”‚ â”‚
â”‚  â”‚    [Profile Photo]                â”‚ â”‚
â”‚  â”‚    ðŸ‘ 3  ðŸ’¬ 1  ðŸ”— Share  5h ago    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ðŸŽ‚ It's Mom's birthday today!     â”‚ â”‚
â”‚  â”‚    Wish her a happy birthday      â”‚ â”‚
â”‚  â”‚    ðŸŽ‰ 12  ðŸ’¬ 8  ðŸ”— Share  1d ago   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Activity Card Design
- Actor avatar (40x40px)
- Action text (bold actor name)
- Timestamp (relative, e.g., "2h ago")
- Content preview (thumbnail or text excerpt)
- Interaction bar (reactions, comments, share)
- Hover state: Slight elevation

### Notification Dropdown
- Bell icon with badge (unread count)
- Click opens dropdown (max 5 recent)
- List of notifications with:
  - Icon based on type
  - Message text
  - Timestamp
  - Unread indicator (blue dot)
- "View All" link at bottom
- "Mark all as read" button

### Mobile Optimizations
- Swipeable feed cards
- Pull-to-refresh
- Simplified interaction bar (icons only)
- Bottom sheet for comments
- Haptic feedback for reactions

---

## Feed Algorithms

### Chronological Feed (Default)
- Show all activities in reverse chronological order
- Simple, predictable
- No filtering or ranking

### Algorithmic Feed (Optional)
Ranking factors:
1. **Recency:** Newer activities ranked higher
2. **Engagement:** Activities with more reactions/comments boosted
3. **Relationship:** Activities from closer family members boosted
4. **Activity type:** Prioritize certain types (birthdays, milestones)
5. **User preferences:** Learn from what user engages with

```sql
-- Example algorithmic feed query
SELECT a.*, 
  (
    -- Recency score (0-10)
    10 * EXP(-EXTRACT(EPOCH FROM (NOW() - a.created_at)) / 86400) +
    -- Engagement score (0-5)
    LEAST(5, (SELECT COUNT(*) FROM feed_reactions WHERE activity_id = a.id)) +
    -- Comment score (0-5)
    LEAST(5, (SELECT COUNT(*) FROM post_comments WHERE post_id = a.entity_id)) +
    -- Relationship score (0-3)
    CASE 
      WHEN a.actor_id IN (SELECT id FROM close_family) THEN 3
      ELSE 1
    END
  ) AS score
FROM activity_feed a
ORDER BY score DESC, a.created_at DESC
LIMIT 20;
```

---

## Notification Types

### In-App Notifications
- New post in tree
- New member added
- Someone reacted to your post
- Someone commented on your post
- Someone mentioned you
- Birthday reminders
- Anniversary reminders

### Email Notifications
- Digest emails (daily/weekly summary)
- Important events (immediate)
- Configurable per notification type

### Email Templates
```
Subject: New activity in [Tree Name]

Hi [User Name],

[Actor Name] added a new memory to [Tree Name]:
"[Post Title]"

[View Memory]

---
You're receiving this because you're a member of [Tree Name].
Update your notification preferences: [Link]
```

---

## Validation Rules

### Reaction Types
- Limited to: like, love, celebrate, laugh
- One reaction type per user per activity
- Can change reaction, not add multiple

### Comments (on feed)
- Max 500 characters
- No HTML tags
- Links auto-detected and made clickable

---

## Performance Optimization

### Feed Loading
- Paginate: 20 activities per page
- Prefetch next page when user scrolls 70%
- Cache feed for 1 minute
- Use Supabase Realtime for new items only

### Notification Loading
- Load 50 notifications initially
- Infinite scroll for more
- Cache unread count for 30 seconds
- Real-time updates for new notifications

### Database Optimization
- Index on tree_id and created_at for fast queries
- Materialize view for notification counts
- Archive old activities (>1 year) to separate table

---

## Acceptance Criteria

âœ… Feed loads within 1 second  
âœ… New activities appear in real-time  
âœ… Reactions update immediately (optimistic UI)  
âœ… Notifications show unread count accurately  
âœ… Email notifications respect user preferences  
âœ… Clicking notification navigates to correct page  
âœ… Feed scrolls smoothly with 100+ activities  
âœ… Mobile users can pull-to-refresh  
âœ… Algorithmic feed shows relevant content  
âœ… Users can turn off notifications per tree  

---

## Accessibility

- **Keyboard navigation:** Tab through feed items, Enter to open
- **Screen reader:** Announce activity type and actor
- **Focus indicators:** Clear border on focused item
- **Notification badges:** Accessible text for counts
- **Color contrast:** Unread indicators meet WCAG AA

---

## Testing Checklist

### Unit Tests
- [ ] Activity creation triggers
- [ ] Notification generation logic
- [ ] Feed ranking algorithm
- [ ] Email digest formatting

### Integration Tests
- [ ] Create post and verify activity appears in feed
- [ ] React to activity and verify notification sent
- [ ] Mark notification as read
- [ ] Update preferences and verify emails respect them

### E2E Tests
- [ ] Complete feed interaction flow
- [ ] Real-time activity appears without refresh
- [ ] Notification dropdown works
- [ ] Email digest sends correctly

### Performance Tests
- [ ] Feed with 1000 activities loads in <2s
- [ ] Real-time updates don't cause lag
- [ ] Notification queries are fast (<100ms)

---

## Error Handling

| Error | Message | Action |
|-------|---------|--------|
| Feed load failed | "Couldn't load feed. Please refresh." | Retry button |
| Reaction failed | "Couldn't add reaction. Try again." | Retry automatically |
| Notification failed | "Notification not sent. Check connection." | Queue for retry |
| Real-time disconnected | "Connection lost. Reconnecting..." | Auto-reconnect |

---

## Success Metrics

- Daily feed views: >50% of active users
- Average time on feed: >3 minutes
- Reaction rate: >30% of feed views
- Comment rate: >10% of feed views
- Notification click-through: >40%
- Email open rate: >25%
- Real-time update latency: <2 seconds

---

## Future Enhancements (Post-MVP)

- Push notifications (mobile and desktop)
- Notification grouping ("John and 3 others reacted to your post")
- Mute/snooze notifications for specific trees
- Smart notifications (ML-based relevance)
- Activity filtering (show only posts, only birthdays, etc.)
- @mentions in comments
- Hashtags for organizing content
- Trending posts within feed
- Story-style ephemeral posts

---

## Notes

- Supabase Realtime makes real-time feed updates trivial
- Focus on performance - feed is high-traffic page
- Email notifications should be thoughtful, not spammy (default to daily digest)
- Consider adding "mark all as read" shortcut (keyboard)
- Birthday reminders are high-value, make them prominent